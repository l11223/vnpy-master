# Mac系统长时间运行稳定性测试指南

## 概述

本指南提供在Mac系统上连续运行VeighNa Trader 24小时稳定性测试的方法和监控工具。

## 测试目标

验证系统在Mac上长时间运行无崩溃，确保系统稳定性。

## 测试环境

1. **Mac系统**：macOS 10.14+（Intel或Apple Silicon）
2. **Python环境**：Python 3.9+
3. **VNPY框架**：已安装并配置完成
4. **测试账户**：模拟账户或测试账户

## 测试准备

### 1. 创建稳定性测试脚本

```python
# stability_test.py
import time
import logging
from datetime import datetime, timedelta
from vnpy.trader.engine import MainEngine
from vnpy.trader.event import EventEngine

# 配置日志
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('stability_test.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

def run_stability_test(duration_hours=24):
    """运行稳定性测试"""
    start_time = datetime.now()
    end_time = start_time + timedelta(hours=duration_hours)
    
    logger.info(f"稳定性测试开始: {start_time}")
    logger.info(f"预计结束时间: {end_time}")
    
    try:
        # 创建事件引擎
        event_engine = EventEngine()
        
        # 创建主引擎
        main_engine = MainEngine(event_engine)
        
        logger.info("主引擎初始化成功")
        
        # 运行测试循环
        error_count = 0
        while datetime.now() < end_time:
            try:
                # 执行定期检查
                time.sleep(60)  # 每分钟检查一次
                
                # 检查引擎状态
                # 检查内存使用
                # 检查连接状态
                # 记录状态
                
                elapsed = datetime.now() - start_time
                logger.info(f"运行时间: {elapsed}, 错误数: {error_count}")
                
            except Exception as e:
                error_count += 1
                logger.error(f"测试循环错误: {e}", exc_info=True)
                
                if error_count > 10:
                    logger.error("错误过多，停止测试")
                    break
        
        elapsed = datetime.now() - start_time
        logger.info(f"稳定性测试完成: 运行时间 {elapsed}, 总错误数: {error_count}")
        
        return error_count == 0
        
    except Exception as e:
        logger.error(f"稳定性测试失败: {e}", exc_info=True)
        return False

if __name__ == '__main__':
    success = run_stability_test(24)
    exit(0 if success else 1)
```

### 2. 监控脚本

```python
# monitor_stability.py
import psutil
import time
from datetime import datetime

def monitor_system():
    """监控系统资源"""
    while True:
        # CPU使用率
        cpu_percent = psutil.cpu_percent(interval=1)
        
        # 内存使用
        memory = psutil.virtual_memory()
        
        # 进程信息
        process = psutil.Process()
        process_memory = process.memory_info().rss / 1024 / 1024  # MB
        
        print(f"[{datetime.now()}] CPU: {cpu_percent}%, "
              f"内存: {memory.percent}%, "
              f"进程内存: {process_memory:.2f}MB")
        
        time.sleep(60)  # 每分钟记录一次

if __name__ == '__main__':
    monitor_system()
```

## 测试步骤

### 步骤1：启动测试

```bash
# 启动稳定性测试（后台运行）
nohup python3 stability_test.py > stability_test.out 2>&1 &

# 记录进程ID
echo $! > stability_test.pid
```

### 步骤2：监控运行

```bash
# 启动监控脚本
python3 monitor_stability.py > monitor.log 2>&1 &

# 定期检查日志
tail -f stability_test.log
```

### 步骤3：检查系统状态

```bash
# 检查进程是否运行
ps aux | grep stability_test

# 检查内存使用
top -pid $(cat stability_test.pid)

# 检查日志错误
grep ERROR stability_test.log
```

### 步骤4：停止测试

```bash
# 正常停止
kill $(cat stability_test.pid)

# 或强制停止
kill -9 $(cat stability_test.pid)
```

## 监控指标

### 1. 系统资源

- **CPU使用率**：应保持在合理范围（<80%）
- **内存使用**：监控内存泄漏
- **磁盘I/O**：检查日志文件大小

### 2. 应用状态

- **引擎运行状态**：检查MainEngine是否正常
- **连接状态**：检查Gateway连接
- **策略状态**：检查策略执行情况

### 3. 错误统计

- **错误数量**：记录所有错误
- **错误类型**：分类统计错误
- **崩溃次数**：记录系统崩溃

## 测试检查清单

- [ ] 系统启动正常
- [ ] 核心模块加载成功
- [ ] Gateway连接稳定
- [ ] 数据服务连接正常
- [ ] 策略执行无异常
- [ ] 内存使用稳定（无泄漏）
- [ ] CPU使用正常
- [ ] 日志记录完整
- [ ] 24小时内无崩溃
- [ ] 所有功能正常

## 预期结果

### 成功标准

1. **无崩溃**：24小时内系统无崩溃
2. **无内存泄漏**：内存使用稳定，无明显增长
3. **功能正常**：所有核心功能正常工作
4. **错误可控**：错误数量在可接受范围内

### 失败标准

1. **系统崩溃**：进程异常退出
2. **内存泄漏**：内存持续增长超过阈值
3. **功能异常**：核心功能无法正常工作
4. **错误过多**：错误数量超过阈值

## 问题处理

### 内存泄漏

如果发现内存持续增长：

1. 检查是否有未释放的资源
2. 检查缓存是否无限增长
3. 检查事件监听器是否正确移除

### 连接断开

如果Gateway连接频繁断开：

1. 检查网络连接
2. 检查Gateway配置
3. 检查重连机制

### 策略异常

如果策略执行异常：

1. 检查策略代码
2. 检查数据质量
3. 检查风控规则

## 测试报告

测试完成后，生成测试报告：

```markdown
# 稳定性测试报告

## 测试信息
- 测试时间：2024-01-XX
- 测试时长：24小时
- Mac系统：macOS XX.X
- Python版本：3.9+

## 测试结果
- 运行状态：✓ 正常 / ✗ 异常
- 崩溃次数：0
- 错误数量：X
- 内存使用：稳定 / 泄漏
- CPU使用：正常

## 问题记录
1. 问题描述
2. 发生时间
3. 影响范围
4. 解决方案

## 结论
系统在Mac上长时间运行稳定 / 存在问题
```

## 注意事项

1. **测试环境**：使用测试账户，不要使用实盘账户
2. **资源监控**：定期检查系统资源使用
3. **日志保存**：保存完整的测试日志
4. **问题记录**：详细记录所有问题和异常
