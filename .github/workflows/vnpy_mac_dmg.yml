# VNPY 纯Mac版dmg GitHub Actions自动打包
name: VNPY Mac DMG Auto Build

# 触发规则：1.推送到main分支自动打包 2.手动触发（推荐）
on:
  push:
    branches: [ main ]  # 【需修改】可改为你的开发分支，如dev
  workflow_dispatch:    # 手动触发开关，保留！

# 仅执行Mac打包作业
jobs:
  build-mac-dmg:
    runs-on: macos-14  # 使用macos-14，资源更充足，排队时间更短
    steps:
      # 步骤1：拉取仓库中的VNPY优化源码
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 步骤2：配置Python3.10环境（VNPY新版本要求>=3.10）
      - name: Set Up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'  # 缓存依赖，大幅加速后续打包

      # 步骤3：安装所有依赖（VNPY+打包工具+底层依赖）
      - name: Install All Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          
          # 安装VNPY（使用开发模式，包含所有修改）
          pip install -e .
          
          # 安装打包工具
          pip install pyinstaller
          
          # 安装create-dmg（Mac DMG制作工具）
          brew install create-dmg || echo "create-dmg安装失败，尝试继续..."
          
          # 安装TA-Lib（VNPY必备）
          brew install ta-lib || echo "ta-lib可能已安装或需要手动处理"
          
          # 安装可选依赖（用于Alpha策略等）
          pip install polars pandas numpy matplotlib || echo "可选依赖安装失败，继续..."
          
          # 验证关键依赖
          python -c "import vnpy; import loguru; import tzlocal; print('✅ 核心依赖验证通过')"
          python -c "import polars; print('✅ polars已安装')" || echo "⚠️  polars未安装（Alpha策略需要）"

      # 步骤4：PyInstaller打包为Mac可执行文件
      - name: Package VNPY via PyInstaller
        run: |
          # 使用--onedir模式（目录模式），更稳定，Mac推荐
          pyinstaller \
          --onedir \
          --windowed \
          --name VNPY-Optimized \
          --add-data "vnpy:vnpy" \
          --hidden-import vnpy \
          --hidden-import vnpy.trader \
          --hidden-import vnpy.trader.platform_utils \
          --hidden-import vnpy.trader.multiprocess_manager \
          --hidden-import vnpy.trader.enhanced_cta_template \
          --hidden-import vnpy.trader.history_manager \
          --hidden-import vnpy.trader.data_filter \
          --hidden-import vnpy.trader.optimization_metrics \
          --hidden-import vnpy.trader.enhanced_risk_manager \
          --hidden-import vnpy.trader.status_monitor \
          --hidden-import vnpy.trader.gateway_mac_adapter \
          --hidden-import vnpy.trader.multiprocess_backtester \
          --hidden-import vnpy.trader.optimization_visualization \
          --hidden-import vnpy.alpha \
          --hidden-import vnpy.alpha.strategy \
          --hidden-import vnpy.alpha.strategy.template \
          --hidden-import vnpy.alpha.strategy.strategies \
          --hidden-import vnpy.event \
          --hidden-import vnpy.trader.engine \
          --hidden-import vnpy.trader.ui \
          --hidden-import vnpy.trader.ui.mainwindow \
          --hidden-import vnpy.trader.ui.widget \
          --hidden-import loguru \
          --hidden-import tzlocal \
          --hidden-import talib \
          --hidden-import PySide6 \
          --hidden-import PySide6.QtCore \
          --hidden-import PySide6.QtGui \
          --hidden-import PySide6.QtWidgets \
          --hidden-import qdarkstyle \
          --collect-all PySide6 \
          --collect-all qdarkstyle \
          --collect-all vnpy \
          "启动量化系统.py"
          
          # 验证打包结果
          if [ -d "dist/VNPY-Optimized" ]; then
            echo "✅ PyInstaller打包成功"
            ls -lh dist/VNPY-Optimized/
          else
            echo "❌ PyInstaller打包失败"
            exit 1
          fi

      # 步骤5：整理Mac标准.app目录结构（保证dmg兼容性）
      - name: Organize Mac App Structure
        run: |
          # 创建.app目录结构
          mkdir -p VNPY.app/Contents/MacOS
          mkdir -p VNPY.app/Contents/Resources
          
          # 复制打包后的文件到.app中
          cp -r dist/VNPY-Optimized/* VNPY.app/Contents/MacOS/
          
          # 创建Info.plist（Mac App必需）
          cat > VNPY.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>VNPY-Optimized</string>
              <key>CFBundleIdentifier</key>
              <string>com.vnpy.optimized</string>
              <key>CFBundleName</key>
              <string>VNPY优化版</string>
              <key>CFBundleVersion</key>
              <string>1.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
          </dict>
          </plist>
          EOF
          
          # 验证.app结构
          if [ -f "VNPY.app/Contents/MacOS/VNPY-Optimized" ]; then
            echo "✅ .app结构创建成功"
            chmod +x VNPY.app/Contents/MacOS/VNPY-Optimized
          else
            echo "⚠️  检查可执行文件位置..."
            # 查找可执行文件
            EXECUTABLE=$(find dist/VNPY-Optimized -type f -perm +111 | head -1)
            if [ -n "$EXECUTABLE" ]; then
              echo "找到可执行文件: $EXECUTABLE"
              # 如果可执行文件在子目录中，需要调整
              if [ -d "dist/VNPY-Optimized/VNPY-Optimized" ]; then
                echo "检测到嵌套目录，调整结构..."
                cp dist/VNPY-Optimized/VNPY-Optimized/* VNPY.app/Contents/MacOS/ 2>/dev/null || true
              fi
              # 再次检查
              if [ -f "VNPY.app/Contents/MacOS/VNPY-Optimized" ]; then
                echo "✅ .app结构创建成功（已修复）"
                chmod +x VNPY.app/Contents/MacOS/VNPY-Optimized
              else
                echo "❌ .app结构创建失败"
                ls -la VNPY.app/Contents/MacOS/
                ls -la dist/VNPY-Optimized/
                exit 1
              fi
            else
              echo "❌ 未找到可执行文件"
              ls -la dist/VNPY-Optimized/
              exit 1
            fi
          fi
          
          # 验证.app可以运行
          echo "验证.app结构..."
          file VNPY.app/Contents/MacOS/VNPY-Optimized || echo "⚠️  可执行文件检查失败，但继续..."

      # 步骤6：制作dmg镜像（Mac安装包，带标准安装界面）
      - name: Build DMG Image
        run: |
          # 创建DMG内容目录
          mkdir -p dmg-contents
          
          # 复制.app到DMG目录
          cp -R VNPY.app dmg-contents/
          
          # 创建Applications文件夹的快捷方式（拖拽目标）
          ln -s /Applications dmg-contents/Applications
          
          # 创建README文件（安装说明）
          cat > dmg-contents/README.txt << 'EOF'
          ============================================
          VNPY Mac优化版 - 安装说明
          ============================================
          
          安装步骤：
          1. 将 VNPY.app 拖拽到 Applications 文件夹
          2. 在启动台找到并打开 VNPY优化版
          3. 首次运行时，右键点击应用 -> 打开（绕过安全验证）
          
          系统要求：
          - macOS 10.15 (Catalina) 或更高版本
          - Apple Silicon (M1/M2/M3) 或 Intel 处理器
          
          功能特性：
          - Mac系统完美适配
          - A股量化交易支持
          - 增强策略模板
          - 多进程策略执行
          - 历史数据管理
          - 优化指标计算
          
          如有问题，请查看使用说明文档。
          ============================================
          EOF
          
          # 检查create-dmg是否可用
          if ! command -v create-dmg &> /dev/null; then
            echo "⚠️  create-dmg未安装，使用hdiutil创建DMG（带安装界面）"
            
            # 使用hdiutil创建临时DMG
            hdiutil create -volname "VNPY优化版-Mac" \
              -srcfolder dmg-contents \
              -ov -format UDRW \
              "VNPY-Mac-Optimized-temp.dmg"
            
            # 挂载临时DMG
            hdiutil attach "VNPY-Mac-Optimized-temp.dmg" -mountpoint /Volumes/VNPY优化版-Mac
            
            # 设置DMG窗口属性（使用AppleScript）
            osascript << 'APPLESCRIPT'
            tell application "Finder"
              tell disk "VNPY优化版-Mac"
                open
                set current view of container window to icon view
                set toolbar visible of container window to false
                set statusbar visible of container window to false
                set the bounds of container window to {200, 120, 1000, 720}
                set viewOptions to the icon view options of container window
                set arrangement of viewOptions to not arranged
                set icon size of viewOptions to 100
                set position of item "VNPY.app" of container window to {200, 300}
                set position of item "Applications" of container window to {600, 300}
                set position of item "README.txt" of container window to {400, 500}
                close
                open
                update without registering applications
                delay 2
              end tell
            end tell
            APPLESCRIPT
            
            # 卸载
            hdiutil detach /Volumes/VNPY优化版-Mac
            
            # 转换为压缩格式
            hdiutil convert "VNPY-Mac-Optimized-temp.dmg" \
              -format UDZO \
              -o "VNPY-Mac-Optimized.dmg"
            
            # 清理临时文件
            rm -f "VNPY-Mac-Optimized-temp.dmg"
          else
            # 使用create-dmg创建更美观的DMG
            create-dmg \
              --volname "VNPY优化版-Mac" \
              --window-pos 200 120 \
              --window-size 800 600 \
              --icon-size 100 \
              --icon "VNPY.app" 200 300 \
              --hide-extension "VNPY.app" \
              --app-drop-link 600 300 \
              --hdiutil-quiet \
              "VNPY-Mac-Optimized.dmg" \
              dmg-contents/
          fi
          
          # 验证DMG文件
          if [ -f "VNPY-Mac-Optimized.dmg" ]; then
            echo "✅ DMG创建成功"
            ls -lh VNPY-Mac-Optimized.dmg
            echo "DMG内容："
            hdiutil attach VNPY-Mac-Optimized.dmg -mountpoint /Volumes/VNPY-TEST -quiet 2>/dev/null || true
            ls -la /Volumes/VNPY-TEST/ 2>/dev/null || true
            hdiutil detach /Volumes/VNPY-TEST -quiet 2>/dev/null || true
          else
            echo "❌ DMG创建失败"
            exit 1
          fi

      # 步骤7：上传dmg产物（可在GitHub直接下载）
      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VNPY-Mac-DMG  # 产物在Action页面的显示名称
          path: ./VNPY-Mac-Optimized.dmg  # 对应步骤6的dmg文件名
