# VNPY Mac版 DMG 自动打包
# 使用最简单可靠的方法：命令行参数 + --onefile 模式
name: VNPY Mac DMG Auto Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-mac-dmg:
    runs-on: macos-14
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Set Up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .
          pip install pyinstaller
          pip install Pillow
          brew install create-dmg || true
          brew install ta-lib || true
          pip install polars pandas numpy matplotlib || true
          python -c "import vnpy; print('VNPY installed')"
          python -c "import PySide6; print('PySide6 installed')"

      - name: Build App with PyInstaller
        run: |
          echo "=========================================="
          echo "PyInstaller Build"
          echo "=========================================="
          
          pyinstaller \
            --onefile \
            --windowed \
            --name "VNPY-Optimized" \
            --add-data "vnpy:vnpy" \
            --hidden-import vnpy \
            --hidden-import vnpy.trader \
            --hidden-import vnpy.trader.ui \
            --hidden-import vnpy.event \
            --hidden-import PySide6 \
            --hidden-import PySide6.QtCore \
            --hidden-import PySide6.QtGui \
            --hidden-import PySide6.QtWidgets \
            --hidden-import qdarkstyle \
            --hidden-import loguru \
            --hidden-import tzlocal \
            --collect-all PySide6 \
            --collect-all qdarkstyle \
            vnpy_launcher.py
          
          echo ""
          echo "=========================================="
          echo "Verify Build Output"
          echo "=========================================="
          
          echo "dist directory:"
          ls -la dist/
          
          if [ -d "dist/VNPY-Optimized.app" ]; then
            echo "APP created successfully"
            echo "Contents:"
            ls -la "dist/VNPY-Optimized.app/Contents/"
            echo "MacOS:"
            ls -la "dist/VNPY-Optimized.app/Contents/MacOS/"
            echo "Info.plist:"
            cat "dist/VNPY-Optimized.app/Contents/Info.plist"
            plutil -lint "dist/VNPY-Optimized.app/Contents/Info.plist"
            /usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" "dist/VNPY-Optimized.app/Contents/Info.plist"
            file "dist/VNPY-Optimized.app/Contents/MacOS/"*
          else
            echo "No .app found, checking for executable..."
            ls -la dist/
            
            if [ -f "dist/VNPY-Optimized" ]; then
              echo "Found executable, creating .app structure manually..."
              mkdir -p "dist/VNPY-Optimized.app/Contents/MacOS"
              mkdir -p "dist/VNPY-Optimized.app/Contents/Resources"
              cp "dist/VNPY-Optimized" "dist/VNPY-Optimized.app/Contents/MacOS/"
              chmod +x "dist/VNPY-Optimized.app/Contents/MacOS/VNPY-Optimized"
              
              printf '%s\n' '<?xml version="1.0" encoding="UTF-8"?>' \
                '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' \
                '<plist version="1.0">' \
                '<dict>' \
                '    <key>CFBundleExecutable</key>' \
                '    <string>VNPY-Optimized</string>' \
                '    <key>CFBundleIdentifier</key>' \
                '    <string>com.vnpy.optimized</string>' \
                '    <key>CFBundleName</key>' \
                '    <string>VNPY</string>' \
                '    <key>CFBundleDisplayName</key>' \
                '    <string>VNPY</string>' \
                '    <key>CFBundleVersion</key>' \
                '    <string>1.0.0</string>' \
                '    <key>CFBundleShortVersionString</key>' \
                '    <string>1.0</string>' \
                '    <key>CFBundlePackageType</key>' \
                '    <string>APPL</string>' \
                '    <key>LSMinimumSystemVersion</key>' \
                '    <string>10.15</string>' \
                '    <key>NSHighResolutionCapable</key>' \
                '    <true/>' \
                '</dict>' \
                '</plist>' > "dist/VNPY-Optimized.app/Contents/Info.plist"
              
              echo "Manual .app structure created"
              ls -la "dist/VNPY-Optimized.app/Contents/"
              ls -la "dist/VNPY-Optimized.app/Contents/MacOS/"
            else
              echo "Build failed - no executable found"
              exit 1
            fi
          fi

      - name: Prepare App for DMG
        run: |
          echo "Preparing .app for DMG..."
          
          rm -rf VNPY.app
          cp -R "dist/VNPY-Optimized.app" VNPY.app
          
          echo "VNPY.app structure:"
          ls -la VNPY.app/Contents/
          ls -la VNPY.app/Contents/MacOS/
          
          EXEC_NAME=$(/usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" VNPY.app/Contents/Info.plist 2>/dev/null || echo "VNPY-Optimized")
          echo "CFBundleExecutable: $EXEC_NAME"
          
          if [ -f "VNPY.app/Contents/MacOS/$EXEC_NAME" ]; then
            echo "Executable exists: VNPY.app/Contents/MacOS/$EXEC_NAME"
            file "VNPY.app/Contents/MacOS/$EXEC_NAME"
            chmod +x "VNPY.app/Contents/MacOS/$EXEC_NAME"
          else
            echo "ERROR: Executable not found!"
            echo "MacOS directory contents:"
            ls -la VNPY.app/Contents/MacOS/
            exit 1
          fi
          
          echo "Code signing..."
          codesign --force --deep --sign - VNPY.app || echo "Signing failed, continuing..."

      - name: Build DMG
        run: |
          echo "Creating DMG..."
          
          mkdir -p dmg-contents
          cp -R VNPY.app dmg-contents/
          ln -s /Applications dmg-contents/Applications
          
          printf '%s\n' \
            "VNPY Mac Quantitative Trading System" \
            "====================================" \
            "" \
            "Installation:" \
            "1. Drag VNPY.app to Applications folder" \
            "2. Right-click -> Open for first run" \
            "" \
            "If you see security warning, run in Terminal:" \
            "xattr -d com.apple.quarantine /Applications/VNPY.app" > dmg-contents/README.txt
          
          if command -v create-dmg > /dev/null 2>&1; then
            echo "Using create-dmg..."
            create-dmg \
              --volname "VNPY Mac" \
              --window-pos 200 120 \
              --window-size 600 400 \
              --icon-size 100 \
              --icon "VNPY.app" 150 200 \
              --app-drop-link 450 200 \
              "VNPY-Mac-Optimized.dmg" \
              dmg-contents/ || hdiutil create -volname "VNPY Mac" -srcfolder dmg-contents -ov -format UDZO "VNPY-Mac-Optimized.dmg"
          else
            echo "Using hdiutil..."
            hdiutil create -volname "VNPY Mac" -srcfolder dmg-contents -ov -format UDZO "VNPY-Mac-Optimized.dmg"
          fi
          
          if [ -f "VNPY-Mac-Optimized.dmg" ]; then
            echo "DMG created successfully"
            ls -lh VNPY-Mac-Optimized.dmg
          else
            echo "DMG creation failed"
            exit 1
          fi

      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VNPY-Mac-DMG
          path: VNPY-Mac-Optimized.dmg
          if-no-files-found: error
