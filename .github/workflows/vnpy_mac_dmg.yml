# VNPY 纯Mac版dmg GitHub Actions自动打包
name: VNPY Mac DMG Auto Build

# 触发规则：1.推送到main分支自动打包 2.手动触发（推荐）
on:
  push:
    branches: [ main ]  # 【需修改】可改为你的开发分支，如dev
  workflow_dispatch:    # 手动触发开关，保留！

# 仅执行Mac打包作业
jobs:
  build-mac-dmg:
    runs-on: macos-12  # 稳定版macOS，兼容VNPY推荐的Python3.9，不建议改
    steps:
      # 步骤1：拉取仓库中的VNPY优化源码
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 步骤2：配置Python3.10环境（VNPY新版本要求>=3.10）
      - name: Set Up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'  # 缓存依赖，大幅加速后续打包

      # 步骤3：安装所有依赖（VNPY+打包工具+底层依赖）
      - name: Install All Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          
          # 安装VNPY（使用开发模式，包含所有修改）
          pip install -e .
          
          # 安装打包工具
          pip install pyinstaller
          
          # 安装create-dmg（Mac DMG制作工具）
          brew install create-dmg || echo "create-dmg安装失败，尝试继续..."
          
          # 安装TA-Lib（VNPY必备）
          brew install ta-lib || echo "ta-lib可能已安装或需要手动处理"
          
          # 验证关键依赖
          python -c "import vnpy; import loguru; import tzlocal; print('✅ 核心依赖验证通过')"

      # 步骤4：PyInstaller打包为Mac可执行文件
      - name: Package VNPY via PyInstaller
        run: |
          # 使用--onedir模式（目录模式），更稳定，Mac推荐
          pyinstaller \
          --onedir \
          --windowed \
          --name VNPY-Optimized \
          --add-data "vnpy:vnpy" \
          --hidden-import vnpy \
          --hidden-import vnpy.trader \
          --hidden-import vnpy.trader.platform_utils \
          --hidden-import vnpy.trader.multiprocess_manager \
          --hidden-import vnpy.trader.enhanced_cta_template \
          --hidden-import vnpy.trader.history_manager \
          --hidden-import vnpy.trader.data_filter \
          --hidden-import vnpy.trader.optimization_metrics \
          --hidden-import vnpy.trader.enhanced_risk_manager \
          --hidden-import vnpy.trader.status_monitor \
          --hidden-import vnpy.trader.gateway_mac_adapter \
          --hidden-import vnpy.event \
          --hidden-import vnpy.trader.engine \
          --hidden-import vnpy.trader.ui \
          --hidden-import loguru \
          --hidden-import tzlocal \
          --hidden-import talib \
          --hidden-import PySide6 \
          --hidden-import qdarkstyle \
          --collect-all PySide6 \
          --collect-all qdarkstyle \
          "启动量化系统.py"
          
          # 验证打包结果
          if [ -d "dist/VNPY-Optimized" ]; then
            echo "✅ PyInstaller打包成功"
            ls -lh dist/VNPY-Optimized/
          else
            echo "❌ PyInstaller打包失败"
            exit 1
          fi

      # 步骤5：整理Mac标准.app目录结构（保证dmg兼容性）
      - name: Organize Mac App Structure
        run: |
          # 创建.app目录结构
          mkdir -p VNPY.app/Contents/MacOS
          mkdir -p VNPY.app/Contents/Resources
          
          # 复制打包后的文件到.app中
          cp -r dist/VNPY-Optimized/* VNPY.app/Contents/MacOS/
          
          # 创建Info.plist（Mac App必需）
          cat > VNPY.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>VNPY-Optimized</string>
              <key>CFBundleIdentifier</key>
              <string>com.vnpy.optimized</string>
              <key>CFBundleName</key>
              <string>VNPY优化版</string>
              <key>CFBundleVersion</key>
              <string>1.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
          </dict>
          </plist>
          EOF
          
          # 验证.app结构
          if [ -f "VNPY.app/Contents/MacOS/VNPY-Optimized" ]; then
            echo "✅ .app结构创建成功"
            chmod +x VNPY.app/Contents/MacOS/VNPY-Optimized
          else
            echo "❌ .app结构创建失败"
            ls -la VNPY.app/Contents/MacOS/
            exit 1
          fi

      # 步骤6：制作dmg镜像（Mac安装包）
      - name: Build DMG Image
        run: |
          # 检查create-dmg是否可用
          if ! command -v create-dmg &> /dev/null; then
            echo "⚠️  create-dmg未安装，尝试使用hdiutil创建DMG"
            # 使用系统自带的hdiutil创建DMG
            hdiutil create -volname "VNPY优化版-Mac" \
              -srcfolder VNPY.app \
              -ov -format UDZO \
              "VNPY-Mac-Optimized.dmg"
          else
            # 使用create-dmg创建更美观的DMG
            create-dmg \
              --volname "VNPY优化版-Mac" \
              --window-pos 200 120 \
              --window-size 800 600 \
              --icon-size 100 \
              --icon VNPY.app 200 300 \
              --hide-extension VNPY.app \
              --app-drop-link 600 300 \
              "VNPY-Mac-Optimized.dmg" \
              ./
          fi
          
          # 验证DMG文件
          if [ -f "VNPY-Mac-Optimized.dmg" ]; then
            echo "✅ DMG创建成功"
            ls -lh VNPY-Mac-Optimized.dmg
          else
            echo "❌ DMG创建失败"
            exit 1
          fi

      # 步骤7：上传dmg产物（可在GitHub直接下载）
      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VNPY-Mac-DMG  # 产物在Action页面的显示名称
          path: ./VNPY-Mac-Optimized.dmg  # 对应步骤6的dmg文件名
