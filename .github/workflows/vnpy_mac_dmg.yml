# VNPY çº¯Macç‰ˆdmg GitHub Actionsè‡ªåŠ¨æ‰“åŒ…
name: VNPY Mac DMG Auto Build

# è§¦å‘è§„åˆ™ï¼š1.æ¨é€åˆ°mainåˆ†æ”¯è‡ªåŠ¨æ‰“åŒ… 2.æ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èï¼‰
on:
  push:
    branches: [ main ]  # ã€éœ€ä¿®æ”¹ã€‘å¯æ”¹ä¸ºä½ çš„å¼€å‘åˆ†æ”¯ï¼Œå¦‚dev
  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘å¼€å…³ï¼Œä¿ç•™ï¼

# ä»…æ‰§è¡ŒMacæ‰“åŒ…ä½œä¸š
jobs:
  build-mac-dmg:
    runs-on: macos-14  # ä½¿ç”¨macos-14ï¼Œèµ„æºæ›´å……è¶³ï¼Œæ’é˜Ÿæ—¶é—´æ›´çŸ­
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä¸­çš„VNPYä¼˜åŒ–æºç 
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šé…ç½®Python3.10ç¯å¢ƒï¼ˆVNPYæ–°ç‰ˆæœ¬è¦æ±‚>=3.10ï¼‰
      - name: Set Up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'  # ç¼“å­˜ä¾èµ–ï¼Œå¤§å¹…åŠ é€Ÿåç»­æ‰“åŒ…

      # æ­¥éª¤3ï¼šå®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆVNPY+æ‰“åŒ…å·¥å…·+åº•å±‚ä¾èµ–ï¼‰
      - name: Install All Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          
          # å®‰è£…VNPYï¼ˆä½¿ç”¨å¼€å‘æ¨¡å¼ï¼ŒåŒ…å«æ‰€æœ‰ä¿®æ”¹ï¼‰
          pip install -e .
          
          # å®‰è£…æ‰“åŒ…å·¥å…·
          pip install pyinstaller
          
          # å®‰è£…å›¾æ ‡å¤„ç†å·¥å…·ï¼ˆPillowç”¨äºå›¾æ ‡è½¬æ¢ï¼‰
          pip install Pillow || echo "Pillowå®‰è£…å¤±è´¥ï¼Œå°†å°è¯•å…¶ä»–æ–¹æ³•..."
          
          # å®‰è£…create-dmgï¼ˆMac DMGåˆ¶ä½œå·¥å…·ï¼‰
          brew install create-dmg || echo "create-dmgå®‰è£…å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
          
          # å®‰è£…TA-Libï¼ˆVNPYå¿…å¤‡ï¼‰
          brew install ta-lib || echo "ta-libå¯èƒ½å·²å®‰è£…æˆ–éœ€è¦æ‰‹åŠ¨å¤„ç†"
          
          # å®‰è£…å¯é€‰ä¾èµ–ï¼ˆç”¨äºAlphaç­–ç•¥ç­‰ï¼‰
          pip install polars pandas numpy matplotlib || echo "å¯é€‰ä¾èµ–å®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
          
          # éªŒè¯å…³é”®ä¾èµ–
          python -c "import vnpy; import loguru; import tzlocal; print('âœ… æ ¸å¿ƒä¾èµ–éªŒè¯é€šè¿‡')"
          python -c "import polars; print('âœ… polarså·²å®‰è£…')" || echo "âš ï¸  polarsæœªå®‰è£…ï¼ˆAlphaç­–ç•¥éœ€è¦ï¼‰"
          python -c "from PIL import Image; print('âœ… Pillowå·²å®‰è£…ï¼ˆå›¾æ ‡å¤„ç†ï¼‰')" || echo "âš ï¸  Pillowæœªå®‰è£…ï¼ˆå›¾æ ‡è½¬æ¢å¯èƒ½å¤±è´¥ï¼‰"

      # æ­¥éª¤4ï¼šPyInstalleræ‰“åŒ…ä¸ºMacå¯æ‰§è¡Œæ–‡ä»¶
      - name: Package VNPY via PyInstaller
        run: |
          # ä½¿ç”¨--windowedå’Œ--onedirè®©PyInstallerè‡ªåŠ¨åˆ›å»º.appç»“æ„
          # --windowed: åˆ›å»ºGUIåº”ç”¨ï¼ˆ.app bundleï¼‰
          # --onedir: ç›®å½•æ¨¡å¼ï¼Œæ›´ç¨³å®š
          # PyInstallerä¼šè‡ªåŠ¨åˆ›å»ºæ­£ç¡®çš„.appç»“æ„
          pyinstaller \
          --windowed \
          --onedir \
          --name VNPY-Optimized \
          --add-data "vnpy:vnpy" \
          --add-data "vnpy/trader/ui/ico:vnpy/trader/ui/ico" \
          --hidden-import vnpy \
          --hidden-import vnpy.trader \
          --hidden-import vnpy.trader.platform_utils \
          --hidden-import vnpy.trader.multiprocess_manager \
          --hidden-import vnpy.trader.enhanced_cta_template \
          --hidden-import vnpy.trader.history_manager \
          --hidden-import vnpy.trader.data_filter \
          --hidden-import vnpy.trader.optimization_metrics \
          --hidden-import vnpy.trader.enhanced_risk_manager \
          --hidden-import vnpy.trader.status_monitor \
          --hidden-import vnpy.trader.gateway_mac_adapter \
          --hidden-import vnpy.trader.multiprocess_backtester \
          --hidden-import vnpy.trader.optimization_visualization \
          --hidden-import vnpy.alpha \
          --hidden-import vnpy.alpha.strategy \
          --hidden-import vnpy.alpha.strategy.template \
          --hidden-import vnpy.alpha.strategy.strategies \
          --hidden-import vnpy.event \
          --hidden-import vnpy.trader.engine \
          --hidden-import vnpy.trader.ui \
          --hidden-import vnpy.trader.ui.mainwindow \
          --hidden-import vnpy.trader.ui.widget \
          --hidden-import loguru \
          --hidden-import tzlocal \
          --hidden-import talib \
          --hidden-import PySide6 \
          --hidden-import PySide6.QtCore \
          --hidden-import PySide6.QtGui \
          --hidden-import PySide6.QtWidgets \
          --hidden-import qdarkstyle \
          --collect-all PySide6 \
          --collect-all qdarkstyle \
          --collect-all vnpy \
          "vnpy_launcher.py"
          
          # éªŒè¯æ‰“åŒ…ç»“æœ
          if [ -d "dist/VNPY-Optimized" ]; then
            echo "âœ… PyInstalleræ‰“åŒ…æˆåŠŸ"
            echo "æ‰“åŒ…ç›®å½•å†…å®¹ï¼š"
            ls -lh dist/VNPY-Optimized/
            echo ""
            echo "æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶ï¼š"
            find dist/VNPY-Optimized -type f -perm +111 -o -name "VNPY-Optimized" | head -10
            echo ""
            # æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶
            if [ -f "dist/VNPY-Optimized/VNPY-Optimized" ]; then
              echo "âœ… æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: dist/VNPY-Optimized/VNPY-Optimized"
              chmod +x dist/VNPY-Optimized/VNPY-Optimized
            else
              echo "âš ï¸  å¯æ‰§è¡Œæ–‡ä»¶ä¸åœ¨é¢„æœŸä½ç½®ï¼ŒæŸ¥æ‰¾ä¸­..."
              EXEC=$(find dist/VNPY-Optimized -type f -perm +111 | head -1)
              if [ -n "$EXEC" ]; then
                echo "æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $EXEC"
              else
                echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
                exit 1
              fi
            fi
          else
            echo "âŒ PyInstalleræ‰“åŒ…å¤±è´¥"
            exit 1
          fi

      # æ­¥éª¤5ï¼šæ•´ç†Macæ ‡å‡†.appç›®å½•ç»“æ„ï¼ˆPyInstallerå·²è‡ªåŠ¨åˆ›å»ºï¼‰
      - name: Organize Mac App Structure
        run: |
          # PyInstallerä½¿ç”¨--windowedä¼šè‡ªåŠ¨åˆ›å»º.appç»“æ„
          # æ£€æŸ¥PyInstalleræ˜¯å¦å·²åˆ›å»º.app
          if [ -d "dist/VNPY-Optimized.app" ]; then
            echo "âœ… PyInstallerå·²è‡ªåŠ¨åˆ›å»º.appç»“æ„"
            # é‡å‘½åä¸ºVNPY.app
            rm -rf VNPY.app
            mv dist/VNPY-Optimized.app VNPY.app
            echo "âœ… .appå·²é‡å‘½åä¸ºVNPY.app"
          else
            echo "âš ï¸  PyInstalleræœªåˆ›å»º.appï¼Œæ£€æŸ¥distç›®å½•ï¼š"
            ls -la dist/
            echo ""
            echo "æŸ¥æ‰¾.appæ–‡ä»¶ï¼š"
            find dist -name "*.app" -type d
            exit 1
          fi
          
          # éªŒè¯.appç»“æ„
          echo "éªŒè¯.appç»“æ„..."
          if [ ! -d "VNPY.app/Contents" ]; then
            echo "âŒ .appç»“æ„ä¸æ­£ç¡®ï¼Œç¼ºå°‘Contentsç›®å½•"
            exit 1
          fi
          
          if [ ! -d "VNPY.app/Contents/MacOS" ]; then
            echo "âŒ .appç»“æ„ä¸æ­£ç¡®ï¼Œç¼ºå°‘MacOSç›®å½•"
            exit 1
          fi
          
          # æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆPyInstallerå¯èƒ½ä½¿ç”¨ä¸åŒçš„åç§°ï¼‰
          EXECUTABLE_NAME=""
          if [ -f "VNPY.app/Contents/MacOS/VNPY-Optimized" ]; then
            EXECUTABLE_NAME="VNPY-Optimized"
            echo "âœ… æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: VNPY-Optimized"
          else
            # æŸ¥æ‰¾MacOSç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶
            EXECUTABLE=$(find VNPY.app/Contents/MacOS -maxdepth 1 -type f -perm +111 2>/dev/null | head -1)
            if [ -n "$EXECUTABLE" ]; then
              EXECUTABLE_NAME=$(basename "$EXECUTABLE")
              echo "âœ… æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $EXECUTABLE_NAME"
              # å¦‚æœåç§°ä¸å¯¹ï¼Œé‡å‘½å
              if [ "$EXECUTABLE_NAME" != "VNPY-Optimized" ]; then
                mv "$EXECUTABLE" VNPY.app/Contents/MacOS/VNPY-Optimized
                EXECUTABLE_NAME="VNPY-Optimized"
                echo "âœ… å·²é‡å‘½åä¸ºVNPY-Optimized"
              fi
            else
              echo "âŒ å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨"
              echo "MacOSç›®å½•å†…å®¹ï¼š"
              ls -la VNPY.app/Contents/MacOS/
              exit 1
            fi
          fi
          
          # ç¡®ä¿å¯æ‰§è¡Œæ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
          chmod +x "VNPY.app/Contents/MacOS/$EXECUTABLE_NAME"
          echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶æƒé™å·²è®¾ç½®"
          
          # éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶
          echo "å¯æ‰§è¡Œæ–‡ä»¶ä¿¡æ¯ï¼š"
          file "VNPY.app/Contents/MacOS/$EXECUTABLE_NAME"
          ls -lh "VNPY.app/Contents/MacOS/$EXECUTABLE_NAME"
          
          echo "âœ… .appç»“æ„éªŒè¯é€šè¿‡"
          
          # åˆ›å»ºåº”ç”¨å›¾æ ‡ï¼ˆä».icoè½¬æ¢ä¸º.icnsï¼‰
          echo "åˆ›å»ºåº”ç”¨å›¾æ ‡..."
          if [ -f "vnpy/trader/ui/ico/vnpy.ico" ]; then
            # åˆ›å»ºä¸´æ—¶å›¾æ ‡ç›®å½•
            mkdir -p icon_temp.iconset
            
            # åˆ›å»ºPythonè„šæœ¬æ–‡ä»¶æ¥è½¬æ¢å›¾æ ‡ï¼ˆä½¿ç”¨printfé¿å…heredocç¼©è¿›é—®é¢˜ï¼‰
            printf '%s\n' \
              'import sys' \
              'from PIL import Image' \
              'import os' \
              '' \
              'try:' \
              '    ico_path = "vnpy/trader/ui/ico/vnpy.ico"' \
              '    if os.path.exists(ico_path):' \
              '        img = Image.open(ico_path)' \
              '        sizes = [' \
              '            (16, 16, "icon_16x16.png"),' \
              '            (32, 32, "icon_16x16@2x.png"),' \
              '            (32, 32, "icon_32x32.png"),' \
              '            (64, 64, "icon_32x32@2x.png"),' \
              '            (128, 128, "icon_128x128.png"),' \
              '            (256, 256, "icon_128x128@2x.png"),' \
              '            (256, 256, "icon_256x256.png"),' \
              '            (512, 512, "icon_256x256@2x.png"),' \
              '            (512, 512, "icon_512x512.png"),' \
              '            (1024, 1024, "icon_512x512@2x.png"),' \
              '        ]' \
              '        os.makedirs("icon_temp.iconset", exist_ok=True)' \
              '        for w, h, name in sizes:' \
              '            resized = img.resize((w, h), Image.Resampling.LANCZOS)' \
              '            resized.save(f"icon_temp.iconset/{name}", "PNG")' \
              '        print("âœ… å›¾æ ‡PNGæ–‡ä»¶å·²ç”Ÿæˆ")' \
              '    else:' \
              '        print("âš ï¸  vnpy.icoä¸å­˜åœ¨ï¼Œè·³è¿‡å›¾æ ‡ç”Ÿæˆ")' \
              'except Exception as e:' \
              '    print(f"âš ï¸  å›¾æ ‡è½¬æ¢å¤±è´¥: {e}")' \
              '    import subprocess' \
              '    try:' \
              '        subprocess.run(["sips", "-s", "format", "png", "--out", "icon_temp.iconset/icon_512x512.png", ico_path], check=True)' \
              '        print("âœ… ä½¿ç”¨sipsè½¬æ¢å›¾æ ‡")' \
              '    except:' \
              '        print("âš ï¸  æ— æ³•è½¬æ¢å›¾æ ‡ï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡")' > convert_icon.py
            
            # è¿è¡ŒPythonè„šæœ¬
            python3 convert_icon.py || echo "âš ï¸  Pythonå›¾æ ‡è½¬æ¢å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨sips..."
            rm -f convert_icon.py
            
            # å¦‚æœPythonè½¬æ¢å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨sipsç›´æ¥è½¬æ¢
            if [ ! -d "icon_temp.iconset" ] || [ -z "$(ls -A icon_temp.iconset 2>/dev/null)" ]; then
              echo "å°è¯•ä½¿ç”¨sipsè½¬æ¢å›¾æ ‡..."
              sips -s format png vnpy/trader/ui/ico/vnpy.ico --out icon_temp.iconset/icon_512x512.png 2>/dev/null || echo "âš ï¸  sipsè½¬æ¢ä¹Ÿå¤±è´¥"
            fi
            
            # ä½¿ç”¨iconutilç”Ÿæˆ.icnsæ–‡ä»¶
            if [ -d "icon_temp.iconset" ] && [ "$(ls -A icon_temp.iconset)" ]; then
              iconutil -c icns icon_temp.iconset -o VNPY.app/Contents/Resources/vnpy.icns 2>/dev/null || {
                echo "âš ï¸  iconutilå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
                # å¦‚æœiconutilå¤±è´¥ï¼Œè‡³å°‘å¤åˆ¶ä¸€ä¸ªPNGä½œä¸ºå¤‡ç”¨
                if [ -f "icon_temp.iconset/icon_512x512.png" ]; then
                  cp icon_temp.iconset/icon_512x512.png VNPY.app/Contents/Resources/vnpy.png
                fi
              }
              rm -rf icon_temp.iconset
              echo "âœ… åº”ç”¨å›¾æ ‡å·²åˆ›å»º"
            else
              echo "âš ï¸  å›¾æ ‡ç›®å½•ä¸ºç©ºï¼Œè·³è¿‡å›¾æ ‡åˆ›å»º"
            fi
          else
            echo "âš ï¸  vnpy.icoä¸å­˜åœ¨ï¼Œè·³è¿‡å›¾æ ‡åˆ›å»º"
          fi
          
          # å¤åˆ¶UIå›¾æ ‡èµ„æºåˆ°MacOSç›®å½•ï¼ˆç¡®ä¿UIå›¾æ ‡å¯ç”¨ï¼‰
          if [ -d "vnpy/trader/ui/ico" ]; then
            echo "å¤åˆ¶UIå›¾æ ‡èµ„æº..."
            mkdir -p VNPY.app/Contents/MacOS/vnpy/trader/ui/ico
            cp -r vnpy/trader/ui/ico/* VNPY.app/Contents/MacOS/vnpy/trader/ui/ico/ 2>/dev/null || true
            echo "âœ… UIå›¾æ ‡èµ„æºå·²å¤åˆ¶"
          fi
          
          # éªŒè¯å›¾æ ‡èµ„æº
          if [ -d "VNPY.app/Contents/MacOS/vnpy/trader/ui/ico" ]; then
            ICON_COUNT=$(find VNPY.app/Contents/MacOS/vnpy/trader/ui/ico -name "*.ico" | wc -l)
            echo "âœ… å›¾æ ‡èµ„æºéªŒè¯: æ‰¾åˆ° $ICON_COUNT ä¸ªå›¾æ ‡æ–‡ä»¶"
          fi
          
          # éªŒè¯åº”ç”¨å›¾æ ‡
          if [ -f "VNPY.app/Contents/Resources/vnpy.icns" ]; then
            echo "âœ… åº”ç”¨å›¾æ ‡æ–‡ä»¶å·²åˆ›å»º: vnpy.icns"
          elif [ -f "VNPY.app/Contents/Resources/vnpy.png" ]; then
            echo "âœ… åº”ç”¨å›¾æ ‡æ–‡ä»¶å·²åˆ›å»º: vnpy.pngï¼ˆå¤‡ç”¨ï¼‰"
          else
            echo "âš ï¸  åº”ç”¨å›¾æ ‡æ–‡ä»¶æœªåˆ›å»ºï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
          fi
          
          # æ›´æ–°Info.plistï¼ˆPyInstallerå·²åˆ›å»ºï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ å›¾æ ‡å’Œä¼˜åŒ–é…ç½®ï¼‰
          # ä½¿ç”¨plutilæ›´æ–°Info.plistï¼ˆæ›´å®‰å…¨ï¼Œä¸ä¼šç ´åç°æœ‰é…ç½®ï¼‰
          if [ -f "VNPY.app/Contents/Info.plist" ]; then
            echo "âœ… Info.plistå·²å­˜åœ¨ï¼Œæ›´æ–°é…ç½®..."
            
            # é¦–å…ˆéªŒè¯CFBundleExecutableæ˜¯å¦æ­£ç¡®
            CURRENT_EXEC=$(/usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" VNPY.app/Contents/Info.plist 2>/dev/null || echo "")
            echo "å½“å‰CFBundleExecutable: $CURRENT_EXEC"
            
            # ç¡®ä¿CFBundleExecutableæŒ‡å‘æ­£ç¡®çš„å¯æ‰§è¡Œæ–‡ä»¶
            if [ -f "VNPY.app/Contents/MacOS/VNPY-Optimized" ]; then
              /usr/libexec/PlistBuddy -c "Set :CFBundleExecutable 'VNPY-Optimized'" VNPY.app/Contents/Info.plist 2>/dev/null || \
              /usr/libexec/PlistBuddy -c "Add :CFBundleExecutable string 'VNPY-Optimized'" VNPY.app/Contents/Info.plist 2>/dev/null || true
              echo "âœ… CFBundleExecutableå·²è®¾ç½®ä¸ºVNPY-Optimized"
            else
              echo "âš ï¸  å¯æ‰§è¡Œæ–‡ä»¶VNPY-Optimizedä¸å­˜åœ¨ï¼Œä½¿ç”¨Info.plistä¸­çš„é…ç½®"
            fi
            
            # éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
            EXEC_NAME=$(/usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" VNPY.app/Contents/Info.plist 2>/dev/null || echo "VNPY-Optimized")
            if [ ! -f "VNPY.app/Contents/MacOS/$EXEC_NAME" ]; then
              echo "âŒ é”™è¯¯ï¼šInfo.plistä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: $EXEC_NAME"
              echo "MacOSç›®å½•ä¸­çš„æ–‡ä»¶ï¼š"
              ls -la VNPY.app/Contents/MacOS/
              exit 1
            fi
            echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶éªŒè¯é€šè¿‡: $EXEC_NAME"
            
            # æ›´æ–°åº”ç”¨åç§°
            /usr/libexec/PlistBuddy -c "Set :CFBundleName 'VNPYä¼˜åŒ–ç‰ˆ'" VNPY.app/Contents/Info.plist 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :CFBundleName string 'VNPYä¼˜åŒ–ç‰ˆ'" VNPY.app/Contents/Info.plist 2>/dev/null || true
            
            # æ›´æ–°Bundle Identifier
            /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier 'com.vnpy.optimized'" VNPY.app/Contents/Info.plist 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :CFBundleIdentifier string 'com.vnpy.optimized'" VNPY.app/Contents/Info.plist 2>/dev/null || true
            
            # æ·»åŠ å›¾æ ‡é…ç½®ï¼ˆå¦‚æœå›¾æ ‡å­˜åœ¨ï¼‰
            if [ -f "VNPY.app/Contents/Resources/vnpy.icns" ]; then
              /usr/libexec/PlistBuddy -c "Set :CFBundleIconFile 'vnpy.icns'" VNPY.app/Contents/Info.plist 2>/dev/null || \
              /usr/libexec/PlistBuddy -c "Add :CFBundleIconFile string 'vnpy.icns'" VNPY.app/Contents/Info.plist 2>/dev/null || true
              echo "âœ… å›¾æ ‡é…ç½®å·²æ·»åŠ "
            elif [ -f "VNPY.app/Contents/Resources/vnpy.png" ]; then
              /usr/libexec/PlistBuddy -c "Set :CFBundleIconFile 'vnpy.png'" VNPY.app/Contents/Info.plist 2>/dev/null || \
              /usr/libexec/PlistBuddy -c "Add :CFBundleIconFile string 'vnpy.png'" VNPY.app/Contents/Info.plist 2>/dev/null || true
              echo "âœ… å›¾æ ‡é…ç½®å·²æ·»åŠ ï¼ˆPNGï¼‰"
            fi
            
            # æ·»åŠ ç¯å¢ƒå˜é‡
            /usr/libexec/PlistBuddy -c "Add :LSEnvironment dict" VNPY.app/Contents/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :LSEnvironment:PYTHONUNBUFFERED string '1'" VNPY.app/Contents/Info.plist 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Set :LSEnvironment:PYTHONUNBUFFERED '1'" VNPY.app/Contents/Info.plist 2>/dev/null || true
            
            # æœ€ç»ˆéªŒè¯Info.plistå’Œå¯æ‰§è¡Œæ–‡ä»¶
            echo ""
            echo "æœ€ç»ˆéªŒè¯ï¼š"
            plutil -lint VNPY.app/Contents/Info.plist && echo "âœ… Info.plistæ ¼å¼æ­£ç¡®" || echo "âŒ Info.plistæ ¼å¼é”™è¯¯"
            FINAL_EXEC=$(/usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" VNPY.app/Contents/Info.plist 2>/dev/null || echo "")
            echo "CFBundleExecutable: $FINAL_EXEC"
            if [ -f "VNPY.app/Contents/MacOS/$FINAL_EXEC" ]; then
              echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨: VNPY.app/Contents/MacOS/$FINAL_EXEC"
              chmod +x "VNPY.app/Contents/MacOS/$FINAL_EXEC"
            else
              echo "âŒ å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: VNPY.app/Contents/MacOS/$FINAL_EXEC"
              exit 1
            fi
          else
            echo "âŒ Info.plistä¸å­˜åœ¨ï¼ŒPyInstalleråº”è¯¥å·²åˆ›å»º"
            exit 1
          fi
          
          # æœ€ç»ˆéªŒè¯.appç»“æ„
          echo "éªŒè¯.appç»“æ„..."
          if [ -f "VNPY.app/Contents/MacOS/VNPY-Optimized" ]; then
            echo "âœ… .appç»“æ„åˆ›å»ºæˆåŠŸ"
            echo ""
            echo "å¯æ‰§è¡Œæ–‡ä»¶ä¿¡æ¯ï¼š"
            ls -lh VNPY.app/Contents/MacOS/VNPY-Optimized
            file VNPY.app/Contents/MacOS/VNPY-Optimized
            echo ""
            echo "MacOSç›®å½•å†…å®¹ï¼š"
            ls -lh VNPY.app/Contents/MacOS/ | head -10
            echo ""
            echo "éªŒè¯Info.plistï¼š"
            if [ -f "VNPY.app/Contents/Info.plist" ]; then
              echo "âœ… Info.plistå­˜åœ¨"
              plutil -lint VNPY.app/Contents/Info.plist || echo "âš ï¸  Info.plistæ ¼å¼å¯èƒ½æœ‰é—®é¢˜"
              echo "CFBundleExecutable:"
              /usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" VNPY.app/Contents/Info.plist 2>/dev/null || echo "æ— æ³•è¯»å–"
            else
              echo "âŒ Info.plistä¸å­˜åœ¨ï¼"
              exit 1
            fi
            chmod +x VNPY.app/Contents/MacOS/VNPY-Optimized
            file VNPY.app/Contents/MacOS/VNPY-Optimized
            ls -lh VNPY.app/Contents/MacOS/VNPY-Optimized
          else
            echo "âŒ .appç»“æ„åˆ›å»ºå¤±è´¥"
            echo "VNPY.app/Contents/MacOS/ ç›®å½•å†…å®¹ï¼š"
            ls -la VNPY.app/Contents/MacOS/ || true
            echo ""
            echo "dist/VNPY-Optimized/ ç›®å½•å†…å®¹ï¼š"
            ls -la dist/VNPY-Optimized/ || true
            exit 1
          fi
          
          # éªŒè¯Info.plist
          if [ -f "VNPY.app/Contents/Info.plist" ]; then
            echo "âœ… Info.plist å·²åˆ›å»º"
          else
            echo "âŒ Info.plist æœªåˆ›å»º"
            exit 1
          fi

      # æ­¥éª¤6ï¼šåˆ¶ä½œdmgé•œåƒï¼ˆMacå®‰è£…åŒ…ï¼Œå¸¦æ ‡å‡†å®‰è£…ç•Œé¢ï¼‰
      - name: Build DMG Image
        run: |
          # åˆ›å»ºDMGå†…å®¹ç›®å½•
          mkdir -p dmg-contents
          
          # å¤åˆ¶.appåˆ°DMGç›®å½•
          cp -R VNPY.app dmg-contents/
          
          # åˆ›å»ºApplicationsæ–‡ä»¶å¤¹çš„å¿«æ·æ–¹å¼ï¼ˆæ‹–æ‹½ç›®æ ‡ï¼‰
          ln -s /Applications dmg-contents/Applications
          
          # åˆ›å»ºREADMEæ–‡ä»¶ï¼ˆå®‰è£…è¯´æ˜ï¼‰
          printf '%s\n' \
            '============================================' \
            'VNPY Macä¼˜åŒ–ç‰ˆ - å®‰è£…è¯´æ˜' \
            '============================================' \
            '' \
            'ğŸ“¦ å®‰è£…æ­¥éª¤ï¼š' \
            '1. å°† VNPY.app æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹' \
            '2. åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆè§£å†³å®‰å…¨æç¤ºï¼‰ï¼š' \
            '   xattr -d com.apple.quarantine /Applications/VNPY.app' \
            '3. ç°åœ¨å¯ä»¥æ­£å¸¸åŒå‡»æ‰“å¼€ VNPYä¼˜åŒ–ç‰ˆäº†ï¼' \
            '' \
            'ğŸ”’ å®‰å…¨æç¤ºå¤„ç†ï¼ˆä¸‰ç§æ–¹æ³•ä»»é€‰å…¶ä¸€ï¼‰ï¼š' \
            'æ–¹æ³•1ï¼ˆæ¨èï¼‰ï¼šåœ¨ç»ˆç«¯æ‰§è¡Œï¼š' \
            '   xattr -d com.apple.quarantine /Applications/VNPY.app' \
            '' \
            'æ–¹æ³•2ï¼šå³é”®ç‚¹å‡» VNPY.app -> é€‰æ‹©"æ‰“å¼€"' \
            '' \
            'æ–¹æ³•3ï¼šç³»ç»Ÿè®¾ç½® -> éšç§ä¸å®‰å…¨æ€§ -> ç‚¹å‡»"ä»è¦æ‰“å¼€"' \
            '' \
            'ğŸ’» ç³»ç»Ÿè¦æ±‚ï¼š' \
            '- macOS 10.15 (Catalina) æˆ–æ›´é«˜ç‰ˆæœ¬' \
            '- Apple Silicon (M1/M2/M3) æˆ– Intel å¤„ç†å™¨' \
            '' \
            'âœ¨ åŠŸèƒ½ç‰¹æ€§ï¼š' \
            '- Macç³»ç»Ÿå®Œç¾é€‚é…' \
            '- Aè‚¡é‡åŒ–äº¤æ˜“æ”¯æŒ' \
            '- å¢å¼ºç­–ç•¥æ¨¡æ¿' \
            '- å¤šè¿›ç¨‹ç­–ç•¥æ‰§è¡Œ' \
            '- å†å²æ•°æ®ç®¡ç†' \
            '- ä¼˜åŒ–æŒ‡æ ‡è®¡ç®—' \
            '' \
            'ğŸ“– æ›´å¤šå¸®åŠ©ï¼š' \
            '- æŸ¥çœ‹ Macå®‰å…¨éªŒè¯å¤„ç†æŒ‡å—.md äº†è§£è¯¦ç»†è¯´æ˜' \
            '- å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä½¿ç”¨è¯´æ˜æ–‡æ¡£' \
            '' \
            '============================================' > dmg-contents/README.txt
          
          # æ£€æŸ¥create-dmgæ˜¯å¦å¯ç”¨
          if ! command -v create-dmg &> /dev/null; then
            echo "âš ï¸  create-dmgæœªå®‰è£…ï¼Œä½¿ç”¨hdiutilåˆ›å»ºDMGï¼ˆå¸¦å®‰è£…ç•Œé¢ï¼‰"
            
            # ä½¿ç”¨hdiutilåˆ›å»ºä¸´æ—¶DMG
            hdiutil create -volname "VNPYä¼˜åŒ–ç‰ˆ-Mac" \
              -srcfolder dmg-contents \
              -ov -format UDRW \
              "VNPY-Mac-Optimized-temp.dmg"
            
            # æŒ‚è½½ä¸´æ—¶DMG
            hdiutil attach "VNPY-Mac-Optimized-temp.dmg" -mountpoint /Volumes/VNPYä¼˜åŒ–ç‰ˆ-Mac
            
            # è®¾ç½®DMGçª—å£å±æ€§ï¼ˆä½¿ç”¨AppleScriptï¼‰
            osascript -e 'tell application "Finder"' \
              -e '  tell disk "VNPYä¼˜åŒ–ç‰ˆ-Mac"' \
              -e '    open' \
              -e '    set current view of container window to icon view' \
              -e '    set toolbar visible of container window to false' \
              -e '    set statusbar visible of container window to false' \
              -e '    set the bounds of container window to {200, 120, 1000, 720}' \
              -e '    set viewOptions to the icon view options of container window' \
              -e '    set arrangement of viewOptions to not arranged' \
              -e '    set icon size of viewOptions to 100' \
              -e '    set position of item "VNPY.app" of container window to {200, 300}' \
              -e '    set position of item "Applications" of container window to {600, 300}' \
              -e '    set position of item "README.txt" of container window to {400, 500}' \
              -e '    close' \
              -e '    open' \
              -e '    update without registering applications' \
              -e '    delay 2' \
              -e '  end tell' \
              -e 'end tell'
            
            # å¸è½½
            hdiutil detach /Volumes/VNPYä¼˜åŒ–ç‰ˆ-Mac
            
            # è½¬æ¢ä¸ºå‹ç¼©æ ¼å¼
            hdiutil convert "VNPY-Mac-Optimized-temp.dmg" \
              -format UDZO \
              -o "VNPY-Mac-Optimized.dmg"
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f "VNPY-Mac-Optimized-temp.dmg"
          else
            # ä½¿ç”¨create-dmgåˆ›å»ºæ›´ç¾è§‚çš„DMG
            create-dmg \
              --volname "VNPYä¼˜åŒ–ç‰ˆ-Mac" \
              --window-pos 200 120 \
              --window-size 800 600 \
              --icon-size 100 \
              --icon "VNPY.app" 200 300 \
              --hide-extension "VNPY.app" \
              --app-drop-link 600 300 \
              --hdiutil-quiet \
              "VNPY-Mac-Optimized.dmg" \
              dmg-contents/
          fi
          
          # éªŒè¯DMGæ–‡ä»¶
          if [ -f "VNPY-Mac-Optimized.dmg" ]; then
            echo "âœ… DMGåˆ›å»ºæˆåŠŸ"
            ls -lh VNPY-Mac-Optimized.dmg
            echo "DMGå†…å®¹ï¼š"
            hdiutil attach VNPY-Mac-Optimized.dmg -mountpoint /Volumes/VNPY-TEST -quiet 2>/dev/null || true
            ls -la /Volumes/VNPY-TEST/ 2>/dev/null || true
            hdiutil detach /Volumes/VNPY-TEST -quiet 2>/dev/null || true
          else
            echo "âŒ DMGåˆ›å»ºå¤±è´¥"
            exit 1
          fi

      # æ­¥éª¤7ï¼šä¸Šä¼ dmgäº§ç‰©ï¼ˆå¯åœ¨GitHubç›´æ¥ä¸‹è½½ï¼‰
      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VNPY-Mac-DMG  # äº§ç‰©åœ¨Actioné¡µé¢çš„æ˜¾ç¤ºåç§°
          path: ./VNPY-Mac-Optimized.dmg  # å¯¹åº”æ­¥éª¤6çš„dmgæ–‡ä»¶å
