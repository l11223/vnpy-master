# VNPY çº¯Macç‰ˆdmg GitHub Actionsè‡ªåŠ¨æ‰“åŒ…
name: VNPY Mac DMG Auto Build

# è§¦å‘è§„åˆ™ï¼š1.æ¨é€åˆ°mainåˆ†æ”¯è‡ªåŠ¨æ‰“åŒ… 2.æ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èï¼‰
on:
  push:
    branches: [ main ]  # ã€éœ€ä¿®æ”¹ã€‘å¯æ”¹ä¸ºä½ çš„å¼€å‘åˆ†æ”¯ï¼Œå¦‚dev
  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘å¼€å…³ï¼Œä¿ç•™ï¼

# ä»…æ‰§è¡ŒMacæ‰“åŒ…ä½œä¸š
jobs:
  build-mac-dmg:
    runs-on: macos-14  # ä½¿ç”¨macos-14ï¼Œèµ„æºæ›´å……è¶³ï¼Œæ’é˜Ÿæ—¶é—´æ›´çŸ­
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä¸­çš„VNPYä¼˜åŒ–æºç 
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šé…ç½®Python3.10ç¯å¢ƒï¼ˆVNPYæ–°ç‰ˆæœ¬è¦æ±‚>=3.10ï¼‰
      - name: Set Up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'  # ç¼“å­˜ä¾èµ–ï¼Œå¤§å¹…åŠ é€Ÿåç»­æ‰“åŒ…

      # æ­¥éª¤3ï¼šå®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆVNPY+æ‰“åŒ…å·¥å…·+åº•å±‚ä¾èµ–ï¼‰
      - name: Install All Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          
          # å®‰è£…VNPYï¼ˆä½¿ç”¨å¼€å‘æ¨¡å¼ï¼ŒåŒ…å«æ‰€æœ‰ä¿®æ”¹ï¼‰
          pip install -e .
          
          # å®‰è£…æ‰“åŒ…å·¥å…·
          pip install pyinstaller
          
          # å®‰è£…create-dmgï¼ˆMac DMGåˆ¶ä½œå·¥å…·ï¼‰
          brew install create-dmg || echo "create-dmgå®‰è£…å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
          
          # å®‰è£…TA-Libï¼ˆVNPYå¿…å¤‡ï¼‰
          brew install ta-lib || echo "ta-libå¯èƒ½å·²å®‰è£…æˆ–éœ€è¦æ‰‹åŠ¨å¤„ç†"
          
          # å®‰è£…å¯é€‰ä¾èµ–ï¼ˆç”¨äºAlphaç­–ç•¥ç­‰ï¼‰
          pip install polars pandas numpy matplotlib || echo "å¯é€‰ä¾èµ–å®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
          
          # éªŒè¯å…³é”®ä¾èµ–
          python -c "import vnpy; import loguru; import tzlocal; print('âœ… æ ¸å¿ƒä¾èµ–éªŒè¯é€šè¿‡')"
          python -c "import polars; print('âœ… polarså·²å®‰è£…')" || echo "âš ï¸  polarsæœªå®‰è£…ï¼ˆAlphaç­–ç•¥éœ€è¦ï¼‰"

      # æ­¥éª¤4ï¼šPyInstalleræ‰“åŒ…ä¸ºMacå¯æ‰§è¡Œæ–‡ä»¶
      - name: Package VNPY via PyInstaller
        run: |
          # ä½¿ç”¨--onediræ¨¡å¼ï¼ˆç›®å½•æ¨¡å¼ï¼‰ï¼Œæ›´ç¨³å®šï¼ŒMacæ¨è
          pyinstaller \
          --onedir \
          --windowed \
          --name VNPY-Optimized \
          --add-data "vnpy:vnpy" \
          --add-data "vnpy/trader/ui/ico:vnpy/trader/ui/ico" \
          --hidden-import vnpy \
          --hidden-import vnpy.trader \
          --hidden-import vnpy.trader.platform_utils \
          --hidden-import vnpy.trader.multiprocess_manager \
          --hidden-import vnpy.trader.enhanced_cta_template \
          --hidden-import vnpy.trader.history_manager \
          --hidden-import vnpy.trader.data_filter \
          --hidden-import vnpy.trader.optimization_metrics \
          --hidden-import vnpy.trader.enhanced_risk_manager \
          --hidden-import vnpy.trader.status_monitor \
          --hidden-import vnpy.trader.gateway_mac_adapter \
          --hidden-import vnpy.trader.multiprocess_backtester \
          --hidden-import vnpy.trader.optimization_visualization \
          --hidden-import vnpy.alpha \
          --hidden-import vnpy.alpha.strategy \
          --hidden-import vnpy.alpha.strategy.template \
          --hidden-import vnpy.alpha.strategy.strategies \
          --hidden-import vnpy.event \
          --hidden-import vnpy.trader.engine \
          --hidden-import vnpy.trader.ui \
          --hidden-import vnpy.trader.ui.mainwindow \
          --hidden-import vnpy.trader.ui.widget \
          --hidden-import loguru \
          --hidden-import tzlocal \
          --hidden-import talib \
          --hidden-import PySide6 \
          --hidden-import PySide6.QtCore \
          --hidden-import PySide6.QtGui \
          --hidden-import PySide6.QtWidgets \
          --hidden-import qdarkstyle \
          --collect-all PySide6 \
          --collect-all qdarkstyle \
          --collect-all vnpy \
          "å¯åŠ¨é‡åŒ–ç³»ç»Ÿ.py"
          
          # éªŒè¯æ‰“åŒ…ç»“æœ
          if [ -d "dist/VNPY-Optimized" ]; then
            echo "âœ… PyInstalleræ‰“åŒ…æˆåŠŸ"
            echo "æ‰“åŒ…ç›®å½•å†…å®¹ï¼š"
            ls -lh dist/VNPY-Optimized/
            echo ""
            echo "æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶ï¼š"
            find dist/VNPY-Optimized -type f -perm +111 -o -name "VNPY-Optimized" | head -10
            echo ""
            # æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶
            if [ -f "dist/VNPY-Optimized/VNPY-Optimized" ]; then
              echo "âœ… æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: dist/VNPY-Optimized/VNPY-Optimized"
              chmod +x dist/VNPY-Optimized/VNPY-Optimized
            else
              echo "âš ï¸  å¯æ‰§è¡Œæ–‡ä»¶ä¸åœ¨é¢„æœŸä½ç½®ï¼ŒæŸ¥æ‰¾ä¸­..."
              EXEC=$(find dist/VNPY-Optimized -type f -perm +111 | head -1)
              if [ -n "$EXEC" ]; then
                echo "æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $EXEC"
              else
                echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
                exit 1
              fi
            fi
          else
            echo "âŒ PyInstalleræ‰“åŒ…å¤±è´¥"
            exit 1
          fi

      # æ­¥éª¤5ï¼šæ•´ç†Macæ ‡å‡†.appç›®å½•ç»“æ„ï¼ˆä¿è¯dmgå…¼å®¹æ€§ï¼‰
      - name: Organize Mac App Structure
        run: |
          # åˆ›å»º.appç›®å½•ç»“æ„
          mkdir -p VNPY.app/Contents/MacOS
          mkdir -p VNPY.app/Contents/Resources
          
          # å¤åˆ¶æ‰“åŒ…åçš„æ–‡ä»¶åˆ°.appä¸­
          echo "å¤åˆ¶æ‰“åŒ…æ–‡ä»¶åˆ°.app..."
          cp -r dist/VNPY-Optimized/* VNPY.app/Contents/MacOS/
          
          # ç¡®ä¿å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨ï¼ˆPyInstaller --onediræ¨¡å¼ï¼‰
          if [ ! -f "VNPY.app/Contents/MacOS/VNPY-Optimized" ]; then
            echo "âš ï¸  å¯æ‰§è¡Œæ–‡ä»¶ä¸åœ¨é¢„æœŸä½ç½®ï¼ŒæŸ¥æ‰¾ä¸­..."
            # æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶
            EXECUTABLE=$(find dist/VNPY-Optimized -type f -perm +111 -o -name "VNPY-Optimized" | head -1)
            if [ -n "$EXECUTABLE" ]; then
              echo "æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $EXECUTABLE"
              # å¤åˆ¶åˆ°æ­£ç¡®ä½ç½®
              cp "$EXECUTABLE" VNPY.app/Contents/MacOS/VNPY-Optimized
              chmod +x VNPY.app/Contents/MacOS/VNPY-Optimized
              echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶å·²å¤åˆ¶åˆ°æ­£ç¡®ä½ç½®"
            else
              echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåˆ—å‡ºdistç›®å½•ï¼š"
              ls -la dist/VNPY-Optimized/
              exit 1
            fi
          fi
          
          # å¤åˆ¶å›¾æ ‡èµ„æºåˆ°Resourcesç›®å½•ï¼ˆç¡®ä¿UIå›¾æ ‡å¯ç”¨ï¼‰
          if [ -d "vnpy/trader/ui/ico" ]; then
            echo "å¤åˆ¶UIå›¾æ ‡èµ„æº..."
            mkdir -p VNPY.app/Contents/MacOS/vnpy/trader/ui/ico
            cp -r vnpy/trader/ui/ico/* VNPY.app/Contents/MacOS/vnpy/trader/ui/ico/ 2>/dev/null || true
            echo "âœ… UIå›¾æ ‡èµ„æºå·²å¤åˆ¶"
          fi
          
          # éªŒè¯å›¾æ ‡èµ„æº
          if [ -d "VNPY.app/Contents/MacOS/vnpy/trader/ui/ico" ]; then
            ICON_COUNT=$(find VNPY.app/Contents/MacOS/vnpy/trader/ui/ico -name "*.ico" | wc -l)
            echo "âœ… å›¾æ ‡èµ„æºéªŒè¯: æ‰¾åˆ° $ICON_COUNT ä¸ªå›¾æ ‡æ–‡ä»¶"
          fi
          
          # åˆ›å»ºInfo.plistï¼ˆMac Appå¿…éœ€ï¼‰
          printf '%s\n' \
            '<?xml version="1.0" encoding="UTF-8"?>' \
            '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' \
            '<plist version="1.0">' \
            '<dict>' \
            '    <key>CFBundleExecutable</key>' \
            '    <string>VNPY-Optimized</string>' \
            '    <key>CFBundleIdentifier</key>' \
            '    <string>com.vnpy.optimized</string>' \
            '    <key>CFBundleName</key>' \
            '    <string>VNPYä¼˜åŒ–ç‰ˆ</string>' \
            '    <key>CFBundleVersion</key>' \
            '    <string>1.0</string>' \
            '    <key>CFBundleShortVersionString</key>' \
            '    <string>1.0</string>' \
            '    <key>CFBundlePackageType</key>' \
            '    <string>APPL</string>' \
            '    <key>LSMinimumSystemVersion</key>' \
            '    <string>10.15</string>' \
            '    <key>NSHighResolutionCapable</key>' \
            '    <true/>' \
            '    <key>LSUIElement</key>' \
            '    <false/>' \
            '</dict>' \
            '</plist>' > VNPY.app/Contents/Info.plist
          
          # æœ€ç»ˆéªŒè¯.appç»“æ„
          echo "éªŒè¯.appç»“æ„..."
          if [ -f "VNPY.app/Contents/MacOS/VNPY-Optimized" ]; then
            echo "âœ… .appç»“æ„åˆ›å»ºæˆåŠŸ"
            chmod +x VNPY.app/Contents/MacOS/VNPY-Optimized
            file VNPY.app/Contents/MacOS/VNPY-Optimized
            ls -lh VNPY.app/Contents/MacOS/VNPY-Optimized
          else
            echo "âŒ .appç»“æ„åˆ›å»ºå¤±è´¥"
            echo "VNPY.app/Contents/MacOS/ ç›®å½•å†…å®¹ï¼š"
            ls -la VNPY.app/Contents/MacOS/ || true
            echo ""
            echo "dist/VNPY-Optimized/ ç›®å½•å†…å®¹ï¼š"
            ls -la dist/VNPY-Optimized/ || true
            exit 1
          fi
          
          # éªŒè¯Info.plist
          if [ -f "VNPY.app/Contents/Info.plist" ]; then
            echo "âœ… Info.plist å·²åˆ›å»º"
          else
            echo "âŒ Info.plist æœªåˆ›å»º"
            exit 1
          fi

      # æ­¥éª¤6ï¼šåˆ¶ä½œdmgé•œåƒï¼ˆMacå®‰è£…åŒ…ï¼Œå¸¦æ ‡å‡†å®‰è£…ç•Œé¢ï¼‰
      - name: Build DMG Image
        run: |
          # åˆ›å»ºDMGå†…å®¹ç›®å½•
          mkdir -p dmg-contents
          
          # å¤åˆ¶.appåˆ°DMGç›®å½•
          cp -R VNPY.app dmg-contents/
          
          # åˆ›å»ºApplicationsæ–‡ä»¶å¤¹çš„å¿«æ·æ–¹å¼ï¼ˆæ‹–æ‹½ç›®æ ‡ï¼‰
          ln -s /Applications dmg-contents/Applications
          
          # åˆ›å»ºREADMEæ–‡ä»¶ï¼ˆå®‰è£…è¯´æ˜ï¼‰
          printf '%s\n' \
            '============================================' \
            'VNPY Macä¼˜åŒ–ç‰ˆ - å®‰è£…è¯´æ˜' \
            '============================================' \
            '' \
            'ğŸ“¦ å®‰è£…æ­¥éª¤ï¼š' \
            '1. å°† VNPY.app æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹' \
            '2. åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆè§£å†³å®‰å…¨æç¤ºï¼‰ï¼š' \
            '   xattr -d com.apple.quarantine /Applications/VNPY.app' \
            '3. ç°åœ¨å¯ä»¥æ­£å¸¸åŒå‡»æ‰“å¼€ VNPYä¼˜åŒ–ç‰ˆäº†ï¼' \
            '' \
            'ğŸ”’ å®‰å…¨æç¤ºå¤„ç†ï¼ˆä¸‰ç§æ–¹æ³•ä»»é€‰å…¶ä¸€ï¼‰ï¼š' \
            'æ–¹æ³•1ï¼ˆæ¨èï¼‰ï¼šåœ¨ç»ˆç«¯æ‰§è¡Œï¼š' \
            '   xattr -d com.apple.quarantine /Applications/VNPY.app' \
            '' \
            'æ–¹æ³•2ï¼šå³é”®ç‚¹å‡» VNPY.app -> é€‰æ‹©"æ‰“å¼€"' \
            '' \
            'æ–¹æ³•3ï¼šç³»ç»Ÿè®¾ç½® -> éšç§ä¸å®‰å…¨æ€§ -> ç‚¹å‡»"ä»è¦æ‰“å¼€"' \
            '' \
            'ğŸ’» ç³»ç»Ÿè¦æ±‚ï¼š' \
            '- macOS 10.15 (Catalina) æˆ–æ›´é«˜ç‰ˆæœ¬' \
            '- Apple Silicon (M1/M2/M3) æˆ– Intel å¤„ç†å™¨' \
            '' \
            'âœ¨ åŠŸèƒ½ç‰¹æ€§ï¼š' \
            '- Macç³»ç»Ÿå®Œç¾é€‚é…' \
            '- Aè‚¡é‡åŒ–äº¤æ˜“æ”¯æŒ' \
            '- å¢å¼ºç­–ç•¥æ¨¡æ¿' \
            '- å¤šè¿›ç¨‹ç­–ç•¥æ‰§è¡Œ' \
            '- å†å²æ•°æ®ç®¡ç†' \
            '- ä¼˜åŒ–æŒ‡æ ‡è®¡ç®—' \
            '' \
            'ğŸ“– æ›´å¤šå¸®åŠ©ï¼š' \
            '- æŸ¥çœ‹ Macå®‰å…¨éªŒè¯å¤„ç†æŒ‡å—.md äº†è§£è¯¦ç»†è¯´æ˜' \
            '- å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä½¿ç”¨è¯´æ˜æ–‡æ¡£' \
            '' \
            '============================================' > dmg-contents/README.txt
          
          # æ£€æŸ¥create-dmgæ˜¯å¦å¯ç”¨
          if ! command -v create-dmg &> /dev/null; then
            echo "âš ï¸  create-dmgæœªå®‰è£…ï¼Œä½¿ç”¨hdiutilåˆ›å»ºDMGï¼ˆå¸¦å®‰è£…ç•Œé¢ï¼‰"
            
            # ä½¿ç”¨hdiutilåˆ›å»ºä¸´æ—¶DMG
            hdiutil create -volname "VNPYä¼˜åŒ–ç‰ˆ-Mac" \
              -srcfolder dmg-contents \
              -ov -format UDRW \
              "VNPY-Mac-Optimized-temp.dmg"
            
            # æŒ‚è½½ä¸´æ—¶DMG
            hdiutil attach "VNPY-Mac-Optimized-temp.dmg" -mountpoint /Volumes/VNPYä¼˜åŒ–ç‰ˆ-Mac
            
            # è®¾ç½®DMGçª—å£å±æ€§ï¼ˆä½¿ç”¨AppleScriptï¼‰
            osascript -e 'tell application "Finder"' \
              -e '  tell disk "VNPYä¼˜åŒ–ç‰ˆ-Mac"' \
              -e '    open' \
              -e '    set current view of container window to icon view' \
              -e '    set toolbar visible of container window to false' \
              -e '    set statusbar visible of container window to false' \
              -e '    set the bounds of container window to {200, 120, 1000, 720}' \
              -e '    set viewOptions to the icon view options of container window' \
              -e '    set arrangement of viewOptions to not arranged' \
              -e '    set icon size of viewOptions to 100' \
              -e '    set position of item "VNPY.app" of container window to {200, 300}' \
              -e '    set position of item "Applications" of container window to {600, 300}' \
              -e '    set position of item "README.txt" of container window to {400, 500}' \
              -e '    close' \
              -e '    open' \
              -e '    update without registering applications' \
              -e '    delay 2' \
              -e '  end tell' \
              -e 'end tell'
            
            # å¸è½½
            hdiutil detach /Volumes/VNPYä¼˜åŒ–ç‰ˆ-Mac
            
            # è½¬æ¢ä¸ºå‹ç¼©æ ¼å¼
            hdiutil convert "VNPY-Mac-Optimized-temp.dmg" \
              -format UDZO \
              -o "VNPY-Mac-Optimized.dmg"
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f "VNPY-Mac-Optimized-temp.dmg"
          else
            # ä½¿ç”¨create-dmgåˆ›å»ºæ›´ç¾è§‚çš„DMG
            create-dmg \
              --volname "VNPYä¼˜åŒ–ç‰ˆ-Mac" \
              --window-pos 200 120 \
              --window-size 800 600 \
              --icon-size 100 \
              --icon "VNPY.app" 200 300 \
              --hide-extension "VNPY.app" \
              --app-drop-link 600 300 \
              --hdiutil-quiet \
              "VNPY-Mac-Optimized.dmg" \
              dmg-contents/
          fi
          
          # éªŒè¯DMGæ–‡ä»¶
          if [ -f "VNPY-Mac-Optimized.dmg" ]; then
            echo "âœ… DMGåˆ›å»ºæˆåŠŸ"
            ls -lh VNPY-Mac-Optimized.dmg
            echo "DMGå†…å®¹ï¼š"
            hdiutil attach VNPY-Mac-Optimized.dmg -mountpoint /Volumes/VNPY-TEST -quiet 2>/dev/null || true
            ls -la /Volumes/VNPY-TEST/ 2>/dev/null || true
            hdiutil detach /Volumes/VNPY-TEST -quiet 2>/dev/null || true
          else
            echo "âŒ DMGåˆ›å»ºå¤±è´¥"
            exit 1
          fi

      # æ­¥éª¤7ï¼šä¸Šä¼ dmgäº§ç‰©ï¼ˆå¯åœ¨GitHubç›´æ¥ä¸‹è½½ï¼‰
      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VNPY-Mac-DMG  # äº§ç‰©åœ¨Actioné¡µé¢çš„æ˜¾ç¤ºåç§°
          path: ./VNPY-Mac-Optimized.dmg  # å¯¹åº”æ­¥éª¤6çš„dmgæ–‡ä»¶å
