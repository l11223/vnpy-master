# VNPY Mac系统A股量化实盘系统 - 使用说明

## 一、系统概述

本项目是VNPY社区版的Mac系统适配版本，专门针对A股股票量化实盘交易进行了优化。

### 特点

- ✅ **无需编译**: Python是解释型语言，直接运行即可
- ✅ **全自动操作**: 提供自动化测试和启动脚本
- ✅ **Mac系统适配**: 完美支持Mac系统（包括Apple Silicon）
- ✅ **A股优化**: 针对A股交易规则优化（T+1、涨跌停、最小交易单位等）
- ✅ **Elite功能**: 复刻了VNPY Elite版的核心功能

## 二、快速开始

### 2.1 安装依赖

```bash
# 安装VNPY基础依赖
pip install vnpy

# 安装其他必要依赖
pip install loguru tzlocal matplotlib numpy

# 如果需要UI界面
pip install PySide6 qdarkstyle
```

### 2.2 启动系统

#### 方式一：UI模式（图形界面）

```bash
python3 启动量化系统.py
```

#### 方式二：无UI模式（后台运行）

```bash
python3 启动量化系统.py --no-ui
```

#### 方式三：测试模式

```bash
python3 启动量化系统.py --test
```

### 2.3 测试量化功能

```bash
python3 测试量化功能.py
```

## 三、详细使用说明

### 3.1 启动脚本参数

```bash
python3 启动量化系统.py [选项]

选项:
  --no-ui       无UI模式（后台运行）
  --test        测试模式
  --skip-check  跳过依赖检查
```

### 3.2 测试脚本功能

`测试量化功能.py` 会自动测试以下功能：

1. ✅ Mac平台工具检测
2. ✅ 多进程管理器
3. ✅ 增强策略模板
4. ✅ 历史数据管理器
5. ✅ 数据过滤器
6. ✅ 优化指标计算
7. ✅ 风险管理器
8. ✅ Gateway适配器

### 3.3 系统功能模块

#### 3.3.1 多进程策略执行

```python
from vnpy.trader.multiprocess_manager import ProcessManager

manager = ProcessManager()
# 启动策略进程
manager.start_strategy_process("strategy_id", strategy_func, config)
```

#### 3.3.2 增强策略模板

```python
from vnpy.trader.enhanced_cta_template import EnhancedCtaTemplate

class MyStrategy(EnhancedCtaTemplate):
    def on_init(self):
        # 初始化
        pass
    
    def on_bars(self, bars):
        # 设置目标仓位
        self.set_target_pos(100)  # 目标持仓100股
```

#### 3.3.3 历史数据管理

```python
from vnpy.trader.history_manager import HistoryManager

manager = HistoryManager()
# 加载K线数据
bars = manager.load_bar_data("000001", "1d", start_date, end_date)
```

#### 3.3.4 风险控制

```python
from vnpy.trader.enhanced_risk_manager import EnhancedRiskManager

risk_manager = EnhancedRiskManager()
# 设置订单频率限制
risk_manager.set_order_rate_limit(100, 60)  # 每分钟最多100单
# 设置持仓限制
risk_manager.set_position_limit("000001", 1000)  # 最大持仓1000股
```

#### 3.3.5 优化指标计算

```python
from vnpy.trader.optimization_metrics import OptimizationMetrics

metrics = OptimizationMetrics()
# 计算Sharpe比率
sharpe = metrics.calculate_sharpe_ratio(returns)
# 计算最大回撤
max_dd = metrics.calculate_max_drawdown(returns)
```

## 四、Gateway配置

### 4.1 XTP接口

1. 从GitHub下载 `vnpy_xtp` 模块
2. 按照 `A股接口Mac适配指南.md` 进行配置
3. 使用 `gateway_mac_adapter.py` 加载动态库

### 4.2 TORA接口

1. 从GitHub下载 `vnpy_tora` 模块
2. 按照 `A股接口Mac适配指南.md` 进行配置
3. 使用 `gateway_mac_adapter.py` 加载动态库

## 五、数据服务配置

### 5.1 RQData

1. 从GitHub下载 `vnpy_rqdata` 模块
2. 按照 `A股数据服务Mac适配指南.md` 进行配置
3. 配置RQData账号

### 5.2 XT数据

1. 从GitHub下载 `vnpy_xt` 模块
2. 按照 `A股数据服务Mac适配指南.md` 进行配置
3. 配置XT账号

## 六、常见问题

### 6.1 缺少依赖

**问题**: `ModuleNotFoundError: No module named 'loguru'`

**解决**:
```bash
pip install loguru tzlocal
```

### 6.2 UI无法启动

**问题**: `ModuleNotFoundError: No module named 'PySide6'`

**解决**:
```bash
pip install PySide6 qdarkstyle
```

或者使用无UI模式：
```bash
python3 启动量化系统.py --no-ui
```

### 6.3 Gateway无法加载

**问题**: Gateway动态库加载失败

**解决**:
1. 检查是否下载了Gateway模块（vnpy_xtp、vnpy_tora等）
2. 检查动态库路径配置
3. 参考 `A股接口Mac适配指南.md`

### 6.4 数据服务连接失败

**问题**: 数据服务无法连接

**解决**:
1. 检查网络连接
2. 检查账号配置
3. 参考 `A股数据服务Mac适配指南.md`

## 七、测试验证

### 7.1 运行所有测试

```bash
python3 run_all_tests.py
```

### 7.2 运行特定测试

```bash
# 阶段二核心逻辑测试
python3 test_phase2_core_logic.py

# 数据服务测试
python3 test_datafeed_mac.py

# Gateway适配器测试
python3 test_gateway_mac_adapter.py
```

### 7.3 量化功能测试

```bash
python3 测试量化功能.py
```

## 八、系统架构

```
vnpy-master/
├── vnpy/
│   └── trader/
│       ├── platform_utils.py          # Mac平台工具
│       ├── gateway_mac_adapter.py     # Gateway适配器
│       ├── multiprocess_manager.py    # 多进程管理器
│       ├── enhanced_cta_template.py   # 增强策略模板
│       ├── history_manager.py         # 历史数据管理
│       ├── data_filter.py             # 数据过滤器
│       ├── optimization_metrics.py    # 优化指标
│       ├── enhanced_risk_manager.py   # 风险控制
│       └── status_monitor.py          # 状态监控
├── 启动量化系统.py                     # 启动脚本
├── 测试量化功能.py                     # 测试脚本
└── 使用说明.md                         # 本文件
```

## 九、性能优化建议

1. **多进程策略**: 使用 `ProcessManager` 实现多进程策略执行，绕过Python GIL限制
2. **数据缓存**: 使用 `HistoryManager` 缓存历史数据，减少重复查询
3. **风险控制**: 使用 `EnhancedRiskManager` 进行实时风险监控
4. **参数优化**: 使用 `OptimizationMetrics` 和 `OptimizationVisualization` 进行参数优化

## 十、技术支持

- **文档**: 查看项目根目录下的各种 `.md` 文件
- **测试**: 运行 `测试量化功能.py` 验证功能
- **日志**: 查看 `logs/` 目录下的日志文件

---

**注意**: 
- Python是解释型语言，**无需编译**，直接运行即可
- 所有脚本都是**全自动**的，无需手动操作
- 测试脚本会自动验证所有功能是否正常
